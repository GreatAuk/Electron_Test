webpackJsonp([79],{1160:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(810);t.default={data:function(){return{currentNode:{mtid:""},planBgImg:"",planLoading:!1,targetData:[],sourceLoading:!1,sourceData:[],elDrag:null,left:"",top:"",delIconVisible:!1,userId:JSON.parse(sessionStorage.getItem("userInfo")).uid}},mounted:function(){this.currentNode.mtid=this.$route.query.mtid,this.Drop(),this.fetchPlan(),this.fetchSource()},methods:{beforeProImgUpload:function(e){if(this.planBgImg="",!this.currentNode.mtid)return void this.$message("请选中位置后再添加底图");var t=new FormData;t.append("file1",e),t.append("mtid",this.currentNode.mtid);var n=new FileReader,a=this;return n.onload=function(){var e=new Image;e.src=this.result,document.querySelector(".hidden-img-wrap").appendChild(e),e.onload=function(){var n=e.offsetWidth,r=e.offsetHeight;t.append("bgWidth",n),t.append("bgHeight",r),a.initPlanWrapSize(n,r),a.uploadImg(t),document.querySelector(".hidden-img-wrap").removeChild(e)}},n.readAsDataURL(e),!1},deleteImg:function(){var e=this;this.$confirm("确认要删除底图?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){n.i(a.d)(e.currentNode.mtid).then(function(t){"00"===JSON.parse(t.data).flag&&(e.planBgImg="")}).catch(function(e){})})},Drag:function(){for(var e=this,t=document.querySelectorAll(".drag-item"),n=0;n<t.length;n++)t[n].addEventListener("dragstart",function(t){if(!e.planBgImg)return e.$message("请先上传底图！"),!1;e.left=t.offsetX,e.top=t.offsetY,e.elDrag=t.target,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain","moveFromSource")},!1),t[n].addEventListener("dragend",function(t){e.delIconVisible=!1},!1)},Drop:function(){var e=this,t=document.querySelector(".target");t.addEventListener("dragover",function(e){return e.preventDefault(),!0},!1),t.addEventListener("drop",function(t){if(t.preventDefault(),"target"===t.target.className){var n=document.querySelector(".plan-wrap .target");e.elDrag.style.left=(t.offsetX-e.left)/~~n.style.width.replace("px","")*100+"%",e.elDrag.style.top=(t.offsetY-e.top)/768*100+"%",e.elDrag.style.position="absolute";var a={};a.mtid=e.elDrag.getAttribute("data-mtid"),a.point="1"===e.elDrag.getAttribute("data-type")?"":parseInt(e.elDrag.getAttribute("data-id")),a.locX=e.elDrag.style.left,a.locY=e.elDrag.style.top,t.target.appendChild(e.elDrag),e.upDatePlan(a)}},!1);var n=document.querySelector(".component-wrap");n.addEventListener("dragover",function(e){return e.preventDefault(),!0},!1),n.addEventListener("dragenter",function(t){n.contains(e.elDrag)||(e.delIconVisible=!0)},!1),n.addEventListener("drop",function(t){if(!n.contains(e.elDrag)){var a={};a.mtid=e.elDrag.getAttribute("data-mtid"),a.point="1"===e.elDrag.getAttribute("data-type")?"":parseInt(e.elDrag.getAttribute("data-id")),e.deletePalnItem(a),t.target.className,e.elDrag.parentNode.removeChild(e.elDrag),e.delIconVisible=!1}},!1)},fetchSource:function(){var e=this;this.sourceLoading=!0,n.i(a.e)(this.currentNode.mtid).then(function(t){e.sourceLoading=!1;var n=JSON.parse(t.data);n.success?e.sourceData=n.list:e.sourceData.length=0,document.querySelector(".config-component-list").innerHTML=e.renderDragDom(e.sourceData),e.Drag()}).catch(function(t){e.$message.error("服务器错误，可配置设备列表获取失败")})},fetchPlan:function(){var e=this;this.structLoading=!0,this.planLoading=!0,n.i(a.f)(this.currentNode.mtid).then(function(t){var n=JSON.parse(t.data);n.success?(e.initPlanWrapSize(n.bgWidth,n.bgHeight),n.list.length?(e.targetData=n.list,document.querySelector(".target").innerHTML=e.renderTargetDom(e.targetData),e.planBgImg=_host+n.img,e.Drag()):(e.planBgImg=_host+n.img,e.targetData=[])):e.targetData=[]}).catch(function(e){}).then(function(){e.structLoading=!1,e.planLoading=!1})},upDatePlan:function(e){var t=this;n.i(a.g)(e).then(function(e){"00"===JSON.parse(e.data).flag?t.$message({type:"success",message:"平面图更新成功"}):t.$message.error("服务器错误，平面图更新失败")}).catch(function(e){t.$message.error("服务器错误，平面图更新失败")})},deletePalnItem:function(e){var t=this;n.i(a.h)(e).then(function(e){"00"===JSON.parse(e.data).flag?(t.fetchSource(),t.$message({type:"success",message:"删除成功"})):t.$message.error("服务器错误，删除失败")}).catch(function(e){t.$message.error("服务器错误，删除失败")})},renderTargetDom:function(e){var t="";return e.forEach(function(e){var n=e.icon;"default"!==n&&""!==n||(2===e.type&&(n="point"),1===e.type&&(n="cube1")),t+='<a title="'+e.name+'" style="left: '+e.locX+"; top: "+e.locY+'; position: absolute" data-mtid="'+e.mtid+'" data-id="'+e.id+'" data-type="'+e.type+'" class="drag-item" draggable="true">\n                    <svg class="icon plan-device-icon" aria-hidden="true"><use xlink:href="#icon-'+n+'"></use></svg></a>'}),t},renderDragDom:function(e){var t="";return e.forEach(function(e){var n=e.icon;"default"===e.icon&&(2===e.type&&(n="point"),1===e.type&&(n="cube1"));var a=2===e.type?e.id:"0";t+='<a title="'+e.name+'" data-mtid="'+e.mtid+'" data-id="'+a+'" class="drag-item" draggable="true">\n                    <span class="drag-icon"><svg class="icon temp-icon" aria-hidden="true"><use xlink:href="#icon-'+n+'"></use></svg><span>\n                    <span class="text">'+e.name+'</span><svg class="icon plan-device-icon" aria-hidden="true"><use xlink:href="#icon-'+n+'"></use></svg></a>'}),t},uploadImg:function(e){var t=this;n.i(a.i)(e).then(function(e){t.planBgImg=_host+e.data,t.$message({type:"success",message:"图片上传成功"})}).catch(function(e){t.$message.error("上传图片错误")})},initPlanWrapSize:function(e,t){document.querySelector(".plan-wrap .target").style.width=e*(768/t)+"px"}}}},1269:function(e,t,n){t=e.exports=n(539)(),t.push([e.i,".planCreate{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;margin:20px}.planCreate-content{display:-ms-flexbox;display:flex}.planCreate-content .struct-wrap{-ms-flex:0 0 300px;flex:0 0 300px;overflow:hidden}.planCreate-content .struct-content{height:725px;padding:15px 10px;overflow:auto}.planCreate-content .struct-content .el-tree{border:none}.planCreate-content .struct-content .el-tree .icon{font-size:16px;margin-right:5px;color:#20a0ff}.planCreate-content .component-wrap{-ms-flex:0 0 200px;flex:0 0 200px}.planCreate-content .component-wrap,.planCreate-content .struct-wrap{border-radius:4px;overflow:hidden}.planCreate-content .component-wrap{position:relative}.planCreate-content .component-wrap .config-component-list{height:755px;padding-left:4px;overflow-y:auto}.planCreate-content .component-wrap .config-component-list:empty{height:0}.planCreate-content .component-wrap .drag-item{display:block;font-size:14px;padding:6px 0;background-color:#fff;border-bottom:1px solid #ddd;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.planCreate-content .component-wrap .icon{font-size:20px;color:#399;margin-right:5px}.planCreate-content .component-wrap .drag-icon{cursor:move}.planCreate-content .component-wrap .delete-icon{display:none;position:absolute;top:0;right:0;left:0;bottom:0;display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center;background:#eff2f7}.planCreate-content .component-wrap .delete-icon i{font-size:60px;text-shadow:0 0 5px #fff;color:#ff4949}.planCreate-content .component-wrap .plan-device-icon{display:none}.planCreate-content .plan-wrap{-ms-flex:1;flex:1;position:relative;margin:0 10px;border-radius:4px;overflow:auto}.planCreate-content .plan-wrap .target{width:1366px;position:relative;margin:auto;height:768px;background-repeat:no-repeat;background-position-x:center;background-size:auto 768px}.planCreate-content .plan-wrap .drag-item{position:relative;cursor:move}.planCreate-content .plan-wrap .drag-item .point{width:15px;height:15px;display:inline-block;border-radius:50%;background:#82d0ea}.planCreate-content .plan-wrap .drag-item .text{display:none}.planCreate-content .plan-wrap .plan-device-icon{font-size:24px;color:#399}.planCreate-content .plan-wrap .temp-icon{display:none}.planCreate-content .delete-btn{position:absolute;top:10px;left:84px;z-index:10;padding:5px}.planCreate-content .preview-btn{position:absolute;top:10px;left:180px;z-index:10;padding:5px}.planCreate-content .plan-bgupload{position:absolute;left:10px;top:10px;z-index:10}.planCreate-content .plan-bgupload .el-upload--text{width:auto;height:auto;border:none}",""])},1399:function(e,t,n){var a=n(1269);"string"==typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);n(540)("395100ed",a,!0)},1552:function(e,t){e.exports={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"planCreate"},[n("div",{staticClass:"planCreate-content"},[n("div",{directives:[{name:"loading",rawName:"v-loading",value:e.planLoading,expression:"planLoading"}],staticClass:"plan-wrap thin-scroll bg-fff",attrs:{"element-loading-text":"加载中..."}},[n("el-button",{staticClass:"preview-btn",attrs:{type:"primary",size:"mini"},nativeOn:{click:function(t){return e.$router.back({query:{mtid:e.currentNode.mtid,tabIndex:e.$route.query.tabIndex}})}}},[n("c-svg",{attrs:{name:"save"}}),e._v("\n        保存\n      ")],1),e._v(" "),n("el-button",{staticClass:"delete-btn",attrs:{type:"primary",size:"mini"},nativeOn:{click:function(t){return e.deleteImg(t)}}},[n("i",{staticClass:"el-icon-delete"}),e._v("\n        删除底图\n      ")]),e._v(" "),n("el-upload",{staticClass:"plan-bgupload",attrs:{"before-upload":e.beforeProImgUpload,action:"2`333",accept:"image/png,image/jpg,image/jpeg"}},[n("el-button",{staticStyle:{padding:"5px"},attrs:{type:"primary",size:"mini"}},[n("c-svg",{attrs:{name:"cloud-upload"}}),e._v("\n          修改底图\n        ")],1)],1),e._v(" "),n("div",{staticClass:"hidden-img-wrap",staticStyle:{position:"fixed",top:"1000000000px"}}),e._v(" "),n("div",{staticClass:"target",style:{"background-image":e.planBgImg?"url("+e.planBgImg+")":"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"}})],1),e._v(" "),n("div",{directives:[{name:"loading",rawName:"v-loading",value:e.sourceLoading,expression:"sourceLoading"}],staticClass:"component-wrap bg-fff",attrs:{"element-loading-text":"加载中..."}},[n("div",{staticClass:"title-wrap"},[n("h3",[n("span",{staticClass:"text"},[e._v("可配置设备/点位")]),e._v(" "),n("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"拖拽将设备/点位放入图中",placement:"top"}},[n("c-svg",{staticStyle:{"margin-left":"10px","font-size":"15px",color:"#339999"},attrs:{name:"what"}})],1)],1)]),e._v(" "),n("div",{staticClass:"config-component-list thin-scroll"}),e._v(" "),e.sourceData.length?e._e():n("div",{staticStyle:{color:"#5e7382","text-align":"center","padding-top":"30px"}},[e._v("\n        暂无可配置设备\n      ")]),e._v(" "),n("transition",{attrs:{name:"el-zoom-in-center"}},[e.delIconVisible?n("div",{staticClass:"delete-icon"},[n("i",{staticClass:"el-icon-delete"})]):e._e()])],1)])])},staticRenderFns:[]}},665:function(e,t,n){n(1399);var a=n(38)(n(1160),n(1552),null,null);e.exports=a.exports},810:function(e,t,n){"use strict";n.d(t,"a",function(){return r}),n.d(t,"c",function(){return i}),n.d(t,"h",function(){return o}),n.d(t,"g",function(){return s}),n.d(t,"e",function(){return l}),n.d(t,"f",function(){return c}),n.d(t,"i",function(){return p}),n.d(t,"d",function(){return d}),n.d(t,"b",function(){return u});var a=n(32),r=function(e,t){return a.a.get("/api/Plan/showInfo",{params:{mtid:e,sid:t}})},i=function(e){return a.a.get("/api/Plan/showlevInfo",{params:{mtid:e}})},o=function(e){return a.a.post("/api/Plan/deleteInfo",e)},s=function(e){return a.a.post("/api/Plan/updateArea",e)},l=function(e){return a.a.get("/api/Plan/getUndistr",{params:{mtid:e,sid:""}})},c=function(e){return a.a.get("/api/Plan/getDistr",{params:{mtid:e,sid:""}})},p=function(e){return a.a.post("/api/Plan/uploadImg",e,{headers:{"Content-Type":"multipart/form-data"}})},d=function(e){return a.a.get("/api/Plan/deleteImg",{params:{id:e}})},u=function(e){return a.a.get("/api/Plan/existImg",{params:{mtid:e}})}}});